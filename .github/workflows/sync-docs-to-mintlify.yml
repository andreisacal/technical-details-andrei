name: ðŸ“š Sync Docs to Mintlify

on:
  pull_request:
    types: [closed]
    branches: [main]
    paths:
      - '**/*.md'
      - '.github/workflows/sync-docs.yml'

concurrency:
  group: sync-docs-${{ github.ref }}
  cancel-in-progress: true

env:
  TARGET_REPO: andreisacal/mintlify-test
  TARGET_PATH: docs-repo
  NODE_VERSION: lts/*
  DOCS_REPO_TOKEN: ${{ secrets.DOCS_REPO_TOKEN }}
  SYNC_BRANCH_PREFIX: auto-sync/
  COMMIT_MESSAGE: "docs: sync from main repository"
  PR_TITLE: "ðŸ“š Sync Documentation from Papi Repository"
  PR_BODY_HEADER: |
    ## Documentation Sync
    
    **Source:** ${{ github.repository }}@${{ github.sha }}
    **Triggered by:** ${{ github.actor }}

    ---
    *This PR was automatically generated by the docs sync workflow.*

jobs:
  sync-docs:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ðŸ”„ Checkout Source Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ðŸ“‚ Checkout Target Docs Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ env.DOCS_REPO_TOKEN }}
          path: ${{ env.TARGET_PATH }}

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ” Detect and Validate Changed Markdown Files
        id: detect
        run: |
          echo "ðŸ“„ Detecting changed Markdown files..."
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD -- '*.md' 2>/dev/null || git ls-tree --name-only -r HEAD -- '*.md')

          echo "ðŸ“Œ Running markdownlint for formatting issues..."
          npm install -g markdownlint-cli
          VALIDATION_ERRORS=""

          while IFS= read -r file; do
            if [ -f "$file" ]; then
              OUTPUT=$(markdownlint "$file" 2>&1 || true)
              if [ -n "$OUTPUT" ]; then
                VALIDATION_ERRORS="${VALIDATION_ERRORS}${OUTPUT}\n"
              fi
            fi
          done <<< "$CHANGED_FILES"

          {
            echo "changed_files<<EOF"
            echo "$CHANGED_FILES"
            echo "EOF"
            echo "validation_errors<<EOF"
            echo -e "$VALIDATION_ERRORS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: ðŸš€ Sync Markdown Files to Target Repo as .mdx
        id: sync
        run: |
          SYNCED_FILES=""
          SKIPPED_FILES=""
          FILES_UPDATED=0

          while IFS= read -r file; do
            if [ -f "$file" ]; then
              filename_base=$(basename "$file" .md)
              target_path=$(find "${{ env.TARGET_PATH }}" -type f -name "${filename_base}.mdx" | head -n 1 || true)

              if [ -n "$target_path" ]; then
                if ! diff -q "$file" "$target_path" >/dev/null; then
                  cp "$file" "$target_path"
                  relpath=$(realpath --relative-to="${{ env.TARGET_PATH }}" "$target_path")
                  SYNCED_FILES="${SYNCED_FILES}âœ… $file -> $relpath\n"
                  FILES_UPDATED=1
                fi
              else
                # Only output the actual file path for missing docs
                SKIPPED_FILES="${SKIPPED_FILES}${file}\n"
              fi
            fi
          done <<< "${{ steps.detect.outputs.changed_files }}"

          {
            echo "synced_files<<EOF"
            echo -e "$SYNCED_FILES"
            echo "EOF"
            echo "skipped_files<<EOF"
            echo -e "$SKIPPED_FILES"
            echo "EOF"
            echo "files_updated=$FILES_UPDATED"
          } >> "$GITHUB_OUTPUT"

      - name: ðŸ“ Create GitHub Issues for Missing Docs
        if: steps.sync.outputs.skipped_files != ''
        uses: actions/github-script@v6
        with:
          script: |
            const skippedFiles = `${{ steps.sync.outputs.skipped_files }}`.split('\n').filter(f => f);
            for (const file of skippedFiles) {
              console.log(`Creating issue for missing file: ${file}`);
              const content = await require('fs').promises.readFile(file, 'utf-8');
              await github.rest.issues.create({
                owner: 'andreisacal',
                repo: 'mintlify-test',
                title: `Missing documentation: ${file}`,
                body: content,
                labels: ['needs-docs'],
              });
            }

      - name: ðŸ“¬ Create Pull Request for Docs Sync
        if: steps.sync.outputs.files_updated == '1'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ env.DOCS_REPO_TOKEN }}
          path: ${{ env.TARGET_PATH }}
          commit-message: ${{ env.COMMIT_MESSAGE }}
          branch: ${{ env.SYNC_BRANCH_PREFIX }}${{ github.sha }}
          delete-branch: true
          title: ${{ env.PR_TITLE }}
          body: |
            ${{ env.PR_BODY_HEADER }}

            ### âœ… Synced Files
            ${{ steps.sync.outputs.synced_files || 'None' }}

            ### âš ï¸ Formatting Issues
            ${{ steps.detect.outputs.validation_errors || 'None' }}

            ### âŒ Skipped Files
            ${{ steps.sync.outputs.skipped_files || 'None' }}

      - name: ðŸ“Š Job Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ“š Documentation Sync Summary
          
          ## âœ… Synced Files
          ${{ steps.sync.outputs.synced_files || 'None' }}
          
          ## âš ï¸ Formatting Issues
          ${{ steps.detect.outputs.validation_errors || 'None' }}
          
          ## âŒ Skipped Files
          ${{ steps.sync.outputs.skipped_files || 'None' }}
          EOF
