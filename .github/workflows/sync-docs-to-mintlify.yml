name: üìö Sync Docs to Mintlify

on:
  pull_request:
    types: [closed]
    branches:
      - main
    paths:
      - '**/*.md'
      - '.github/workflows/sync-docs.yml'

concurrency:
  group: sync-docs-${{ github.ref }}
  cancel-in-progress: true

env:
  TARGET_REPO: andreisacal/mintlify-test
  TARGET_PATH: docs-repo
  NODE_VERSION: lts/*
  SYNC_BRANCH_PREFIX: auto-sync/
  DOCS_REPO_TOKEN: ${{ secrets.DOCS_REPO_TOKEN }}
  REVIEWERS: andreisacal

jobs:
  sync-docs:
    name: Sync Documentation
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: üîÑ Checkout Source Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: üìÇ Checkout Target Docs Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ env.DOCS_REPO_TOKEN }}
          path: ${{ env.TARGET_PATH }}

      - name: ‚ö° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üì¶ Install Dependencies
        run: npm install -g markdownlint-cli

      - name: üîç Detect Changed Markdown Files
        id: detect
        run: |
          echo "üìÑ Detecting changed Markdown files..."
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD -- '*.md' 2>/dev/null || git ls-tree --name-only -r HEAD -- '*.md')
          if [ -z "$CHANGED_FILES" ]; then
            echo "No markdown files changed."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          FILTERED=$(echo "$CHANGED_FILES" | grep -Ev '(^|/)README\.md$|(^|/)CONTRIBUTING\.md$' || true)
          if [ -z "$FILTERED" ]; then
            echo "üõë Only README.md or CONTRIBUTING.md changed. Skipping documentation sync."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "‚úÖ Markdown changes detected that require sync:"
          echo "$FILTERED"
          echo "has_changes=true" >> "$GITHUB_OUTPUT"
          echo "changed_files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$FILTERED" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: ‚úÖ Validate Markdown Files
        if: steps.detect.outputs.has_changes == 'true'
        id: validate
        continue-on-error: true
        run: |
          echo "üìå Running markdownlint..."
          VALIDATION_ERRORS=""
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              OUTPUT=$(markdownlint "$file" 2>&1 || true)
              if [ -n "$OUTPUT" ]; then
                VALIDATION_ERRORS="${VALIDATION_ERRORS}**${file}**:\n${OUTPUT}\n\n"
              fi
            fi
          done <<< "${{ steps.detect.outputs.changed_files }}"
          {
            echo "validation_errors<<EOF"
            echo -e "$VALIDATION_ERRORS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: üöÄ Sync Files to Target Repository
        if: steps.detect.outputs.has_changes == 'true'
        id: sync
        run: |
          SYNCED_FILES=""
          SKIPPED_FILES=""
          FILES_UPDATED=0
          while IFS= read -r file; do
            [ ! -f "$file" ] && continue
            filename_base=$(basename "$file" .md)
            target_path=$(find "${{ env.TARGET_PATH }}" -type f -name "${filename_base}.mdx" | head -n 1)
            if [ -n "$target_path" ]; then
              if ! diff -q "$file" "$target_path" >/dev/null 2>&1; then
                cp "$file" "$target_path"
                relpath=$(realpath --relative-to="${{ env.TARGET_PATH }}" "$target_path")
                SYNCED_FILES="${SYNCED_FILES}- ‚úÖ \`${file}\` ‚Üí \`${relpath}\`\n"
                FILES_UPDATED=1
              fi
            else
              SKIPPED_FILES="${SKIPPED_FILES}- ‚ùå \`${file}\` (no matching .mdx file found)\n"
            fi
          done <<< "${{ steps.detect.outputs.changed_files }}"
          {
            echo "synced_files<<EOF"
            echo -e "$SYNCED_FILES"
            echo "EOF"
            echo "skipped_files<<EOF"
            echo -e "$SKIPPED_FILES"
            echo "EOF"
            echo "files_updated=$FILES_UPDATED"
            echo "has_skipped=$([[ -n "$SKIPPED_FILES" ]] && echo 'true' || echo 'false')"
          } >> "$GITHUB_OUTPUT"

      - name: üìù Create Issues for Missing Documentation
        if: steps.sync.outputs.has_skipped == 'true'
        id: create_issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.DOCS_REPO_TOKEN }}
          script: |
            const fs = require('fs').promises;
            const skippedRaw = process.env.SKIPPED_FILES || '';
            const skippedFiles = skippedRaw
              .split('\n')
              .map(line => (line.match(/`([^`]+)`/) || [])[1])
              .filter(Boolean);
            console.log('Skipped files detected:', skippedFiles);
            let issueUrls = [];
            for (const file of skippedFiles) {
              try {
                const content = await fs.readFile(file, 'utf8');
                const fileName = file.split('/').pop();
                const issue = await github.rest.issues.create({
                  owner: '${{ env.TARGET_REPO }}'.split('/')[0],
                  repo: '${{ env.TARGET_REPO }}'.split('/')[1],
                  title: `üìÑ Missing documentation: ${fileName}`,
                  body: [
                    `## Missing Documentation File`,
                    `**Source:** \`${file}\``,
                    `**Repository:** ${{ github.repository }}`,
                    `**Commit:** ${{ github.sha }}`,
                    '',
                    `### Content Preview`,
                    '```markdown',
                    content.length > 1000 ? content.slice(0,1000) + '\n...(truncated)' : content,
                    '```',
                    '',
                    '---',
                    '*This issue was automatically created by the docs sync workflow.*'
                  ].join('\n'),
                  labels: ['documentation', 'needs-docs', 'auto-created'],
                  assignees: ['${{ env.REVIEWERS }}']
                });
                issueUrls.push(issue.data.html_url);
              } catch (error) {
                console.error(`‚ùå Failed to create issue for ${file}:`, error.message);
              }
            }
            core.setOutput('issue-urls', issueUrls.join(','));
        env:
          SKIPPED_FILES: ${{ steps.sync.outputs.skipped_files }}

      - name: Export Issue URLs
        if: steps.create_issues.outputs.issue-urls
        run: echo "ISSUE_URLS=${{ steps.create_issues.outputs.issue-urls }}" >> $GITHUB_ENV

      - name: üì¨ Create Pull Request
        id: create_pr
        if: steps.sync.outputs.files_updated == '1'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ env.DOCS_REPO_TOKEN }}
          path: ${{ env.TARGET_PATH }}
          commit-message: "docs: sync from ${{ github.repository }}@${{ github.sha }}"
          branch: ${{ env.SYNC_BRANCH_PREFIX }}${{ github.run_id }}
          delete-branch: true
          title: üìö Sync Documentation from ${{ github.repository }}
          body: |
            ## üìö Documentation Sync
            
            **Source Repository:** ${{ github.repository }}
            **Source Commit:** ${{ github.sha }}
            **Triggered By:** @${{ github.actor }}
            
            ---
            
            ### ‚úÖ Synced Files
            ${{ steps.sync.outputs.synced_files || '_No files were synced_' }}
            
            ### ‚ö†Ô∏è Validation Warnings
            ${{ steps.validate.outputs.validation_errors || '_No validation issues found_' }}

            ---
            
            <sub>ü§ñ This PR was automatically generated by the [docs sync workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>
          labels: |
            documentation
            auto-sync
          #  reviewers: ${{ env.REVIEWERS }}

      - name: üìä Generate Summary
        if: always() && steps.detect.outputs.has_changes == 'true'
        run: |
          # Get PR URL, synced and skipped files
          PR_URL="${{ steps.create_pr.outputs.pull-request-url }}"
          SYNCED_FILES="${{ steps.sync.outputs.synced_files }}"
          SKIPPED_FILES="${{ steps.sync.outputs.skipped_files }}"

          # Prepare issue links safely
          if [ -n "$ISSUE_URLS" ]; then
            ISSUES_FORMATTED=$(echo "$ISSUE_URLS" | tr ',' '\n' | sed 's|^|- [View Issue](&)|')
          else
            ISSUES_FORMATTED="_No issues created_"
          fi

          # Prepare validation errors safely
          VALIDATION_ERRORS="${{ steps.validate.outputs.validation_errors }}"
          if [ -z "$VALIDATION_ERRORS" ]; then
            VALIDATION_ERRORS="_No validation issues found_"
          fi

          # Append safely to GitHub Step Summary
          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          # üìö Documentation Sync Summary

          ## ‚úÖ Documentation Files Updated
          These files were automatically synced from the technical repository to the front-facing documentation repository.
          $SYNCED_FILES

          ${PR_URL:+[View Pull Request]($PR_URL)}

          ## ‚ö†Ô∏è Markdown Validation Warnings
          Some files may have formatting issues. These warnings do **not prevent syncing**, but you may want to review them:
          $VALIDATION_ERRORS

          ## ‚ùå Files Not Synced
          These files could not be synced because they're missing in the documentation repo.  
          A GitHub issue was automatically created for each ‚Äî the documentation team should review and add them.

          Files:
          $SKIPPED_FILES

          $ISSUES_FORMATTED
          EOF


