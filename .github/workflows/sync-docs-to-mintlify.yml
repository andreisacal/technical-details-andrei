name: üìö Sync Docs to Mintlify

on:
  pull_request:
    types: [closed]
    branches:
      - main
    paths:
      - '**/*.md'
      - '.github/workflows/sync-docs.yml'

concurrency:
  group: sync-docs-${{ github.ref }}
  cancel-in-progress: true

env:
  TARGET_REPO: andreisacal/mintlify-test
  TARGET_PATH: docs-repo
  NODE_VERSION: lts/*
  SYNC_BRANCH_PREFIX: auto-sync/
  DOCS_REPO_TOKEN: ${{ secrets.DOCS_REPO_TOKEN }}
  REVIEWERS: andreisacal

jobs:
  sync-docs:
    name: Sync Documentation
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: üîÑ Checkout Source Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: üìÇ Checkout Target Docs Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ env.DOCS_REPO_TOKEN }}
          path: ${{ env.TARGET_PATH }}

      - name: ‚ö° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üì¶ Install Dependencies
        run: npm install -g markdownlint-cli

      - name: üîç Detect Changed Markdown Files
        id: detect
        run: |
          echo "üìÑ Detecting changed Markdown files..."
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD -- '*.md' 2>/dev/null || git ls-tree --name-only -r HEAD -- '*.md')
          if [ -z "$CHANGED_FILES" ]; then
            echo "No markdown files changed."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          FILTERED=$(echo "$CHANGED_FILES" | grep -Ev '(^|/)README\.md$|(^|/)CONTRIBUTING\.md$' || true)
          if [ -z "$FILTERED" ]; then
            echo "üõë Only README.md or CONTRIBUTING.md changed. Skipping documentation sync."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "‚úÖ Markdown changes detected that require sync:"
          echo "$FILTERED"
          echo "has_changes=true" >> "$GITHUB_OUTPUT"
          echo "changed_files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$FILTERED" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: ‚úÖ Validate Markdown Files
        if: steps.detect.outputs.has_changes == 'true'
        id: validate
        continue-on-error: true
        run: |
          echo "üìå Running markdownlint..."
          # Create a temporary file to store validation results
          VALIDATION_FILE=$(mktemp)
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              OUTPUT=$(markdownlint "$file" 2>&1 || true)
              if [ -n "$OUTPUT" ]; then
                # Store validation results with file as key (using ||| as delimiter)
                echo "${file}|||${OUTPUT}" >> "$VALIDATION_FILE"
              fi
            fi
          done <<< "${{ steps.detect.outputs.changed_files }}"
          
          # Save the validation file path
          echo "validation_file=$VALIDATION_FILE" >> "$GITHUB_OUTPUT"

      - name: üöÄ Sync Files to Target Repository
        if: steps.detect.outputs.has_changes == 'true'
        id: sync
        run: |
          SYNCED_FILES=""
          SKIPPED_FILES=""
          SYNCED_WARNINGS=""
          SKIPPED_WARNINGS=""
          FILES_UPDATED=0
          
          # Read validation file if it exists
          VALIDATION_FILE="${{ steps.validate.outputs.validation_file }}"
          
          while IFS= read -r file; do
            [ ! -f "$file" ] && continue
            filename_base=$(basename "$file" .md)
            target_path=$(find "${{ env.TARGET_PATH }}" -type f -name "${filename_base}.mdx" | head -n 1)
            
            # Get validation warnings for this file
            FILE_WARNINGS=""
            if [ -f "$VALIDATION_FILE" ]; then
              FILE_WARNINGS=$(grep "^${file}|||" "$VALIDATION_FILE" | sed "s|^${file}|||||" || true)
            fi
            
            if [ -n "$target_path" ]; then
              # File can be synced
              if ! diff -q "$file" "$target_path" >/dev/null 2>&1; then
                cp "$file" "$target_path"
                relpath=$(realpath --relative-to="${{ env.TARGET_PATH }}" "$target_path")
                SYNCED_FILES="${SYNCED_FILES}- ‚úÖ \`${file}\` ‚Üí \`${relpath}\`\n"
                FILES_UPDATED=1
                
                # Add warnings for synced files
                if [ -n "$FILE_WARNINGS" ]; then
                  SYNCED_WARNINGS="${SYNCED_WARNINGS}**${file}**:\n${FILE_WARNINGS}\n\n"
                fi
              fi
            else
              # File cannot be synced
              SKIPPED_FILES="${SKIPPED_FILES}- ‚ùå \`${file}\` (no matching .mdx file found)\n"
              
              # Add warnings for skipped files
              if [ -n "$FILE_WARNINGS" ]; then
                SKIPPED_WARNINGS="${SKIPPED_WARNINGS}**${file}**:\n${FILE_WARNINGS}\n\n"
              fi
            fi
          done <<< "${{ steps.detect.outputs.changed_files }}"
          
          {
            echo "synced_files<<EOF"
            echo -e "$SYNCED_FILES"
            echo "EOF"
            echo "skipped_files<<EOF"
            echo -e "$SKIPPED_FILES"
            echo "EOF"
            echo "synced_warnings<<EOF"
            echo -e "$SYNCED_WARNINGS"
            echo "EOF"
            echo "skipped_warnings<<EOF"
            echo -e "$SKIPPED_WARNINGS"
            echo "EOF"
            echo "files_updated=$FILES_UPDATED"
            echo "has_skipped=$([[ -n "$SKIPPED_FILES" ]] && echo 'true' || echo 'false')"
          } >> "$GITHUB_OUTPUT"

      - name: üìù Create Issues for Missing Documentation
        if: steps.sync.outputs.has_skipped == 'true'
        id: create_issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.DOCS_REPO_TOKEN }}
          script: |
            const fs = require('fs').promises;
            const skippedRaw = process.env.SKIPPED_FILES || '';
            const skippedFiles = skippedRaw
              .split('\n')
              .map(line => (line.match(/`([^`]+)`/) || [])[1])
              .filter(Boolean);
            console.log('Skipped files detected:', skippedFiles);
            
            const skippedWarnings = process.env.SKIPPED_WARNINGS || '';
            
            let issueUrls = [];
            for (const file of skippedFiles) {
              try {
                const content = await fs.readFile(file, 'utf8');
                const fileName = file.split('/').pop();
                
                // Extract warnings for this specific file
                const fileWarningMatch = skippedWarnings.match(new RegExp(`\\*\\*${file.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\*\\*:\\n([\\s\\S]*?)(?=\\n\\n|$)`));
                const fileWarnings = fileWarningMatch ? fileWarningMatch[1].trim() : '';
                
                let issueBody = [
                  `## Missing Documentation File`,
                  `**Source:** \`${file}\``,
                  `**Repository:** ${{ github.repository }}`,
                  `**Commit:** ${{ github.sha }}`,
                  ''
                ];
                
                // Add validation warnings if they exist
                if (fileWarnings) {
                  issueBody.push(
                    `### ‚ö†Ô∏è Validation Warnings`,
                    '```',
                    fileWarnings,
                    '```',
                    ''
                  );
                }
                
                issueBody.push(
                  `### Content Preview`,
                  '```markdown',
                  content.length > 1000 ? content.slice(0,1000) + '\n...(truncated)' : content,
                  '```',
                  '',
                  '---',
                  '*This issue was automatically created by the docs sync workflow.*'
                );
                
                const issue = await github.rest.issues.create({
                  owner: '${{ env.TARGET_REPO }}'.split('/')[0],
                  repo: '${{ env.TARGET_REPO }}'.split('/')[1],
                  title: `üìÑ Missing documentation: ${fileName}`,
                  body: issueBody.join('\n'),
                  labels: ['documentation', 'needs-docs', 'auto-created'],
                  assignees: ['${{ env.REVIEWERS }}']
                });
                issueUrls.push(issue.data.html_url);
              } catch (error) {
                console.error(`‚ùå Failed to create issue for ${file}:`, error.message);
              }
            }
            core.setOutput('issue-urls', issueUrls.join(','));
        env:
          SKIPPED_FILES: ${{ steps.sync.outputs.skipped_files }}
          SKIPPED_WARNINGS: ${{ steps.sync.outputs.skipped_warnings }}

      - name: Export Issue URLs
        if: steps.create_issues.outputs.issue-urls
        run: echo "ISSUE_URLS=${{ steps.create_issues.outputs.issue-urls }}" >> $GITHUB_ENV

      - name: üì¨ Create Pull Request
        id: create_pr
        if: steps.sync.outputs.files_updated == '1'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ env.DOCS_REPO_TOKEN }}
          path: ${{ env.TARGET_PATH }}
          commit-message: "docs: sync from ${{ github.repository }}@${{ github.sha }}"
          branch: ${{ env.SYNC_BRANCH_PREFIX }}${{ github.run_id }}
          delete-branch: true
          title: üìö Sync Documentation from ${{ github.repository }}
          body: |
            ## üìö Documentation Sync
            
            **Source Repository:** ${{ github.repository }}
            **Source Commit:** ${{ github.sha }}
            **Triggered By:** @${{ github.actor }}
            
            ---
            
            ### ‚úÖ Synced Files
            ${{ steps.sync.outputs.synced_files || '_No files were synced_' }}
            
            ### ‚ö†Ô∏è Validation Warnings
            ${{ steps.sync.outputs.synced_warnings || '_No validation issues found for synced files_' }}

            ---
            
            <sub>ü§ñ This PR was automatically generated by the [docs sync workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>
          labels: |
            documentation
            auto-sync
          #  reviewers: ${{ env.REVIEWERS }}

      - name: üìä Generate Summary
        if: always() && steps.detect.outputs.has_changes == 'true'
        run: |
          # Get PR URL
          PR_URL="${{ steps.create_pr.outputs.pull-request-url }}"
          
          # Get synced files and their warnings
          SYNCED_FILES=$(cat << 'INNER_EOF'
          ${{ steps.sync.outputs.synced_files }}
          INNER_EOF
          )
          SYNCED_WARNINGS=$(cat << 'INNER_EOF'
          ${{ steps.sync.outputs.synced_warnings }}
          INNER_EOF
          )
          
          # Get skipped files and their warnings
          SKIPPED_FILES=$(cat << 'INNER_EOF'
          ${{ steps.sync.outputs.skipped_files }}
          INNER_EOF
          )
          SKIPPED_WARNINGS=$(cat << 'INNER_EOF'
          ${{ steps.sync.outputs.skipped_warnings }}
          INNER_EOF
          )

          # Prepare issue links safely
          if [ -n "$ISSUE_URLS" ]; then
            ISSUES_FORMATTED=$(echo "$ISSUE_URLS" | tr ',' '\n' | sed 's|^|- [View Issue](&)|')
          else
            ISSUES_FORMATTED="_No issues created_"
          fi

          # Default messages for empty warnings
          if [ -z "$SYNCED_WARNINGS" ]; then
            SYNCED_WARNINGS="_No validation issues found for synced files_"
          fi
          
          if [ -z "$SKIPPED_WARNINGS" ]; then
            SKIPPED_WARNINGS="_No validation issues found for skipped files_"
          fi

          # Append to GitHub Step Summary
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          # üìö Documentation Sync Summary

          ## ‚úÖ Documentation Files Updated
          These files were automatically synced from the technical repository to the front-facing documentation repository.
          EOF
          
          echo "$SYNCED_FILES" >> "$GITHUB_STEP_SUMMARY"
          
          if [ -n "$PR_URL" ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "[View Pull Request]($PR_URL)" >> "$GITHUB_STEP_SUMMARY"
          fi
          
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'

          ### ‚ö†Ô∏è Validation Warnings (Synced Files)
          EOF
          echo "$SYNCED_WARNINGS" >> "$GITHUB_STEP_SUMMARY"
          
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'

          ## ‚ùå Files Not Synced
          These files could not be synced because they're missing in the documentation repo.  
          A GitHub issue was automatically created for each ‚Äî the documentation team should review and add them.

          ### Files:
          EOF
          echo "$SKIPPED_FILES" >> "$GITHUB_STEP_SUMMARY"
          
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'

          ### ‚ö†Ô∏è Validation Warnings (Skipped Files)
          EOF
          echo "$SKIPPED_WARNINGS" >> "$GITHUB_STEP_SUMMARY"
          
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'

          ### Created Issues:
          EOF
          echo "$ISSUES_FORMATTED" >> "$GITHUB_STEP_SUMMARY"