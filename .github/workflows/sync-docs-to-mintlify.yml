name: üìö Sync Docs to Mintlify

on:
  pull_request:
    types: [closed]
    branches: [main]
    paths:
      - '**/*.md'
      - '.github/workflows/sync-docs.yml'

concurrency:
  group: sync-docs-${{ github.ref }}
  cancel-in-progress: true

env:
  TARGET_REPO: andreisacal/mintlify-test
  TARGET_PATH: docs-repo
  NODE_VERSION: lts/*
  SYNC_BRANCH_PREFIX: auto-sync/

jobs:
  sync-docs:
    name: Sync Documentation
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: üîÑ Checkout Source Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: üìÇ Checkout Target Docs Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ secrets.DOCS_REPO_TOKEN }}
          path: ${{ env.TARGET_PATH }}

      - name: ‚ö° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üì¶ Install Dependencies
        run: npm install -g markdownlint-cli

      - name: üîç Detect Changed Markdown Files
        id: detect
        run: |
          echo "üìÑ Detecting changed Markdown files..."
          
          # Get changed markdown files
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD -- '*.md' 2>/dev/null || git ls-tree --name-only -r HEAD -- '*.md')
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No markdown files changed"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          echo "has_changes=true" >> "$GITHUB_OUTPUT"
          echo "changed_files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGED_FILES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: ‚úÖ Validate Markdown Files
        if: steps.detect.outputs.has_changes == 'true'
        id: validate
        continue-on-error: true
        run: |
          echo "üìå Running markdownlint..."
          VALIDATION_ERRORS=""
          
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              OUTPUT=$(markdownlint "$file" 2>&1 || true)
              if [ -n "$OUTPUT" ]; then
                VALIDATION_ERRORS="${VALIDATION_ERRORS}**${file}**:\n${OUTPUT}\n\n"
              fi
            fi
          done <<< "${{ steps.detect.outputs.changed_files }}"
          
          {
            echo "validation_errors<<EOF"
            echo -e "$VALIDATION_ERRORS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: üöÄ Sync Files to Target Repository
        if: steps.detect.outputs.has_changes == 'true'
        id: sync
        run: |
          SYNCED_FILES=""
          SKIPPED_FILES=""
          FILES_UPDATED=0
          
          while IFS= read -r file; do
            if [ ! -f "$file" ]; then
              continue
            fi
            
            filename_base=$(basename "$file" .md)
            target_path=$(find "${{ env.TARGET_PATH }}" -type f -name "${filename_base}.mdx" | head -n 1)
            
            if [ -n "$target_path" ]; then
              # File exists in target repo - check if it needs updating
              if ! diff -q "$file" "$target_path" >/dev/null 2>&1; then
                cp "$file" "$target_path"
                relpath=$(realpath --relative-to="${{ env.TARGET_PATH }}" "$target_path")
                SYNCED_FILES="${SYNCED_FILES}- ‚úÖ \`${file}\` ‚Üí \`${relpath}\`\n"
                FILES_UPDATED=1
              fi
            else
              # File doesn't exist in target repo
              SKIPPED_FILES="${SKIPPED_FILES}- ‚ùå \`${file}\` (no matching .mdx file found)\n"
            fi
          done <<< "${{ steps.detect.outputs.changed_files }}"
          
          {
            echo "synced_files<<EOF"
            echo -e "$SYNCED_FILES"
            echo "EOF"
            echo "skipped_files<<EOF"
            echo -e "$SKIPPED_FILES"
            echo "EOF"
            echo "files_updated=$FILES_UPDATED"
            echo "has_skipped=$([[ -n "$SKIPPED_FILES" ]] && echo 'true' || echo 'false')"
          } >> "$GITHUB_OUTPUT"

      - name: üìù Create Issues for Missing Documentation
        if: steps.sync.outputs.has_skipped == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DOCS_REPO_TOKEN }}
          script: |
            const fs = require('fs').promises;
            const skippedFiles = `${{ steps.sync.outputs.skipped_files }}`
              .split('\n')
              .filter(f => f)
              .map(f => f.match(/`([^`]+)`/)?.[1])
              .filter(Boolean);
            
            for (const file of skippedFiles) {
              try {
                console.log(`Creating issue for missing file: ${file}`);
                const content = await fs.readFile(file, 'utf-8');
                const fileName = file.split('/').pop();
                
                await github.rest.issues.create({
                  owner: '${{ env.TARGET_REPO }}'.split('/')[0],
                  repo: '${{ env.TARGET_REPO }}'.split('/')[1],
                  title: `üìÑ Missing documentation: ${fileName}`,
                  body: `## Missing Documentation File\n\n**Source:** \`${file}\`\n**Repository:** ${{ github.repository }}\n**Commit:** ${{ github.sha }}\n\n### Content Preview\n\n\`\`\`markdown\n${content.slice(0, 1000)}${content.length > 1000 ? '\n...(truncated)' : ''}\n\`\`\`\n\n---\n*This issue was automatically created by the docs sync workflow.*`,
                  labels: ['documentation', 'needs-docs', 'auto-created'],
                });
              } catch (error) {
                console.error(`Failed to create issue for ${file}: ${error.message}`);
              }
            }

      - name: üì¨ Create Pull Request
        if: steps.sync.outputs.files_updated == '1'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.DOCS_REPO_TOKEN }}
          path: ${{ env.TARGET_PATH }}
          commit-message: "docs: sync from ${{ github.repository }}@${{ github.sha }}"
          branch: ${{ env.SYNC_BRANCH_PREFIX }}${{ github.run_id }}
          delete-branch: true
          title: üìö Sync Documentation from ${{ github.repository }}
          body: |
            ## üìö Documentation Sync
            
            **Source Repository:** ${{ github.repository }}
            **Source Commit:** ${{ github.sha }}
            **Triggered By:** @${{ github.actor }}
            **PR:** #${{ github.event.pull_request.number }}
            
            ---
            
            ### ‚úÖ Synced Files
            ${{ steps.sync.outputs.synced_files || '_No files were synced_' }}
            
            ### ‚ö†Ô∏è Validation Warnings
            ${{ steps.validate.outputs.validation_errors || '_No validation issues found_' }}
            
            ### ‚ùå Skipped Files
            ${{ steps.sync.outputs.skipped_files || '_No files were skipped_' }}
            
            ---
            
            <sub>ü§ñ This PR was automatically generated by the [docs sync workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>
          labels: |
            documentation
            auto-sync

      - name: üìä Generate Summary
        if: always() && steps.detect.outputs.has_changes == 'true'
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # üìö Documentation Sync Summary
          
          ## ‚úÖ Synced Files
          ${{ steps.sync.outputs.synced_files || '_No files were synced_' }}
          
          ## ‚ö†Ô∏è Validation Warnings
          ${{ steps.validate.outputs.validation_errors || '_No validation issues found_' }}
          
          ## ‚ùå Skipped Files
          ${{ steps.sync.outputs.skipped_files || '_No files were skipped_' }}
          EOF
